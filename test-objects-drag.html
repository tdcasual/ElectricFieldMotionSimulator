<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–°å¯¹è±¡æ‹–æ‹½åŠŸèƒ½æµ‹è¯•</title>
    <link rel="stylesheet" href="styles/theme.css">
    <link rel="stylesheet" href="styles/main.css">
    <link rel="stylesheet" href="styles/components.css">
    <style>
        body {
            padding: 20px;
        }
        .test-section {
            background: var(--bg-secondary);
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
        h2 {
            color: var(--accent-blue);
            margin-top: 0;
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            border-left: 4px solid var(--accent-blue);
        }
        .test-result.pass {
            background: var(--success-green);
            opacity: 0.1;
            border-left-color: var(--success-green);
        }
        .test-result.fail {
            background: var(--error-red);
            opacity: 0.15;
            border-left-color: var(--error-red);
        }
        canvas {
            border: 2px solid var(--border-color);
            background: var(--bg-primary);
            margin: 10px 0;
        }
        .drag-test {
            background: var(--bg-tertiary);
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            cursor: grab;
            display: inline-block;
        }
        .drag-test:active {
            cursor: grabbing;
        }
        code {
            background: var(--bg-tertiary);
            padding: 2px 6px;
            border-radius: 3px;
            font-family: monospace;
        }
    </style>
</head>
<body class="dark-theme">
    <h1>ğŸ§ª æ–°å¯¹è±¡æ‹–æ‹½åŠŸèƒ½æµ‹è¯•</h1>
    
    <div class="test-section">
        <h2>æµ‹è¯•åœºæ™¯Canvas</h2>
        <canvas id="test-canvas" width="800" height="400"></canvas>
        <p>
            <button class="btn btn-primary" id="start-test-btn">å¼€å§‹æµ‹è¯•</button>
            <button class="btn" id="clear-canvas-btn">æ¸…ç©ºCanvas</button>
        </p>
    </div>
    
    <div class="test-section">
        <h2>å¯æ‹–æ‹½æµ‹è¯•å…ƒç´ </h2>
        <div class="drag-test" draggable="true" data-type="electric-field-semicircle">
            ğŸ“ åŠåœ†ç”µåœº
        </div>
        <div class="drag-test" draggable="true" data-type="capacitor">
            âš¡ å¹³è¡Œæ¿ç”µå®¹å™¨
        </div>
        <p style="color: var(--text-secondary);">ğŸ’¡ æç¤º: å°è¯•å°†è¿™äº›å…ƒç´ æ‹–åˆ°Canvasä¸Š</p>
    </div>
    
    <div class="test-section">
        <h2>æµ‹è¯•ç»“æœ</h2>
        <div id="test-results"></div>
    </div>

    <script type="module">
        import { Scene } from './js/core/Scene.js';
        import { DragDropManager } from './js/interactions/DragDropManager.js';
        import { Renderer } from './js/core/Renderer.js';
        
        const canvas = document.getElementById('test-canvas');
        const ctx = canvas.getContext('2d');
        const resultsDiv = document.getElementById('test-results');
        
        let testsPassed = 0;
        let testsFailed = 0;
        
        function log(message, isPass) {
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${isPass ? 'pass' : 'fail'}`;
            resultDiv.innerHTML = message;
            resultsDiv.appendChild(resultDiv);
            
            if (isPass) testsPassed++;
            else testsFailed++;
            
            console.log(message);
        }
        
        function drawCanvas() {
            ctx.fillStyle = '#2d2d30';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // ç»˜åˆ¶ç½‘æ ¼
            ctx.strokeStyle = 'rgba(51, 51, 51, 0.5)';
            ctx.lineWidth = 1;
            const gridSize = 50;
            
            for (let x = 0; x <= canvas.width; x += gridSize) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, canvas.height);
                ctx.stroke();
            }
            
            for (let y = 0; y <= canvas.height; y += gridSize) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(canvas.width, y);
                ctx.stroke();
            }
        }
        
        async function runTests() {
            log('ğŸ§ª å¼€å§‹æµ‹è¯•æ–°å¯¹è±¡æ‹–æ‹½åŠŸèƒ½...', true);
            
            try {
                // æµ‹è¯•1: åˆ›å»ºScene
                log('âœ… åˆ›å»ºSceneå®ä¾‹', true);
                const scene = new Scene();
                
                // æµ‹è¯•2: åˆ›å»ºRenderer
                log('âœ… åˆ›å»ºRendererå®ä¾‹', true);
                const renderer = new Renderer();
                renderer.init();
                
                // æµ‹è¯•3: åˆ›å»ºDragDropManager
                log('âœ… åˆ›å»ºDragDropManagerå®ä¾‹', true);
                const dragDropManager = new DragDropManager(scene, renderer);
                
                // æµ‹è¯•4: æµ‹è¯•createObjectæ–¹æ³• - åŠåœ†ç”µåœº
                log('âœ… æµ‹è¯• DragDropManager.createObject() - åŠåœ†ç”µåœº', true);
                dragDropManager.createObject('electric-field-semicircle', 200, 100);
                const semiField = scene.electricFields[scene.electricFields.length - 1];
                if (semiField && semiField.type === 'semicircle-electric-field') {
                    log('âœ… åŠåœ†ç”µåœºåˆ›å»ºæˆåŠŸï¼ŒType: ' + semiField.type, true);
                } else {
                    log('âŒ åŠåœ†ç”µåœºåˆ›å»ºå¤±è´¥', false);
                }
                
                // æµ‹è¯•5: æµ‹è¯•createObjectæ–¹æ³• - å¹³è¡Œæ¿ç”µå®¹å™¨
                log('âœ… æµ‹è¯• DragDropManager.createObject() - å¹³è¡Œæ¿ç”µå®¹å™¨', true);
                dragDropManager.createObject('capacitor', 400, 100);
                const capacitor = scene.electricFields[scene.electricFields.length - 1];
                if (capacitor && capacitor.type === 'parallel-plate-capacitor') {
                    log('âœ… å¹³è¡Œæ¿ç”µå®¹å™¨åˆ›å»ºæˆåŠŸï¼ŒType: ' + capacitor.type, true);
                } else {
                    log('âŒ å¹³è¡Œæ¿ç”µå®¹å™¨åˆ›å»ºå¤±è´¥', false);
                }
                
                // æµ‹è¯•6: æµ‹è¯•findObjectAt - æŸ¥æ‰¾åŠåœ†ç”µåœº
                log('âœ… æµ‹è¯• Scene.findObjectAt() - æŸ¥æ‰¾åŠåœ†ç”µåœº', true);
                const foundSemi = scene.findObjectAt(200, 100);
                if (foundSemi && foundSemi.type === 'semicircle-electric-field') {
                    log('âœ… æˆåŠŸæ‰¾åˆ°åŠåœ†ç”µåœº', true);
                } else {
                    log('âŒ æœªèƒ½æ‰¾åˆ°åŠåœ†ç”µåœº', false);
                }
                
                // æµ‹è¯•7: æµ‹è¯•findObjectAt - æŸ¥æ‰¾å¹³è¡Œæ¿ç”µå®¹å™¨
                log('âœ… æµ‹è¯• Scene.findObjectAt() - æŸ¥æ‰¾å¹³è¡Œæ¿ç”µå®¹å™¨', true);
                const foundCap = scene.findObjectAt(400, 100);
                if (foundCap && foundCap.type === 'parallel-plate-capacitor') {
                    log('âœ… æˆåŠŸæ‰¾åˆ°å¹³è¡Œæ¿ç”µå®¹å™¨', true);
                } else {
                    log('âŒ æœªèƒ½æ‰¾åˆ°å¹³è¡Œæ¿ç”µå®¹å™¨', false);
                }
                
                // æµ‹è¯•8: æµ‹è¯•åºåˆ—åŒ–
                log('âœ… æµ‹è¯•åºåˆ—åŒ– - åŠåœ†ç”µåœº', true);
                const semiData = semiField.serialize();
                if (semiData.type === 'semicircle-electric-field') {
                    log('âœ… åŠåœ†ç”µåœºåºåˆ—åŒ–æˆåŠŸ', true);
                } else {
                    log('âŒ åŠåœ†ç”µåœºåºåˆ—åŒ–å¤±è´¥', false);
                }
                
                // æµ‹è¯•9: æµ‹è¯•åºåˆ—åŒ– - å¹³è¡Œæ¿ç”µå®¹å™¨
                log('âœ… æµ‹è¯•åºåˆ—åŒ– - å¹³è¡Œæ¿ç”µå®¹å™¨', true);
                const capData = capacitor.serialize();
                if (capData.type === 'parallel-plate-capacitor') {
                    log('âœ… å¹³è¡Œæ¿ç”µå®¹å™¨åºåˆ—åŒ–æˆåŠŸ', true);
                } else {
                    log('âŒ å¹³è¡Œæ¿ç”µå®¹å™¨åºåˆ—åŒ–å¤±è´¥', false);
                }
                
                // ç»˜åˆ¶ç»“æœ
                drawCanvas();
                
                // ç»˜åˆ¶å¯¹è±¡è¾¹ç•Œï¼ˆç”¨äºå¯è§†åŒ–ï¼‰
                ctx.strokeStyle = 'rgba(255, 200, 0, 0.6)';
                ctx.lineWidth = 2;
                
                // ç»˜åˆ¶åŠåœ†ç”µåœº
                if (semiField) {
                    ctx.beginPath();
                    ctx.arc(semiField.x, semiField.y, semiField.radius, 0, Math.PI * 2);
                    ctx.stroke();
                    ctx.fillStyle = 'rgba(255, 200, 0, 0.1)';
                    ctx.fill();
                }
                
                // ç»˜åˆ¶å¹³è¡Œæ¿ç”µå®¹å™¨ï¼ˆä¸¤æ¡ææ¿ + è¿æ¥è™šçº¿ï¼‰
                if (capacitor) {
                    const plateAngle = (capacitor.direction + 90) * Math.PI / 180;
                    const fieldAngle = capacitor.direction * Math.PI / 180;
                    const cosPlate = Math.cos(plateAngle);
                    const sinPlate = Math.sin(plateAngle);
                    const cosField = Math.cos(fieldAngle);
                    const sinField = Math.sin(fieldAngle);
                    const halfWidth = capacitor.width / 2;
                    const halfDist = capacitor.plateDistance / 2;
                    
                    const plate1 = [
                        { x: capacitor.x - cosPlate * halfWidth - cosField * halfDist, y: capacitor.y - sinPlate * halfWidth - sinField * halfDist },
                        { x: capacitor.x + cosPlate * halfWidth - cosField * halfDist, y: capacitor.y + sinPlate * halfWidth - sinField * halfDist }
                    ];
                    const plate2 = [
                        { x: capacitor.x - cosPlate * halfWidth + cosField * halfDist, y: capacitor.y - sinPlate * halfWidth + sinField * halfDist },
                        { x: capacitor.x + cosPlate * halfWidth + cosField * halfDist, y: capacitor.y + sinPlate * halfWidth + sinField * halfDist }
                    ];
                    
                    ctx.strokeStyle = 'rgba(100, 150, 255, 0.8)';
                    ctx.lineWidth = 3;
                    ctx.beginPath();
                    ctx.moveTo(plate1[0].x, plate1[0].y);
                    ctx.lineTo(plate1[1].x, plate1[1].y);
                    ctx.stroke();
                    
                    ctx.beginPath();
                    ctx.moveTo(plate2[0].x, plate2[0].y);
                    ctx.lineTo(plate2[1].x, plate2[1].y);
                    ctx.stroke();
                    
                    ctx.strokeStyle = 'rgba(100, 100, 100, 0.3)';
                    ctx.setLineDash([5, 5]);
                    ctx.beginPath();
                    ctx.moveTo(plate1[0].x, plate1[0].y);
                    ctx.lineTo(plate2[0].x, plate2[0].y);
                    ctx.moveTo(plate1[1].x, plate1[1].y);
                    ctx.lineTo(plate2[1].x, plate2[1].y);
                    ctx.stroke();
                    ctx.setLineDash([]);
                }
                
                // æ€»ç»“
                log('', true);
                log(`ğŸ“Š æµ‹è¯•å®Œæˆ: ${testsPassed}/${testsPassed + testsFailed} é€šè¿‡`, testsFailed === 0);
                
            } catch (error) {
                log(`âŒ æµ‹è¯•è¿‡ç¨‹ä¸­å‡ºé”™: ${error.message}`, false);
                console.error(error);
            }
        }
        
        // äº‹ä»¶ç›‘å¬
        document.getElementById('start-test-btn').addEventListener('click', runTests);
        document.getElementById('clear-canvas-btn').addEventListener('click', drawCanvas);
        
        // åˆå§‹åŒ–Canvas
        drawCanvas();
        
        // è‡ªåŠ¨è¿è¡Œæµ‹è¯•
        setTimeout(runTests, 500);
    </script>
</body>
</html>
