# 相切提示与吸附设计（边界摆放）

日期：2026-02-12
状态：已评审（用户确认）
范围：拖拽与缩放交互中的“相切提示 + 自动吸附”

## 1. 背景与目标

当前场对象支持拖拽、缩放与选中高亮，但在对象边界接近“相切”位置时，缺乏明确反馈。用户希望在摆放对象时获得以下能力：

1. 可视化提示当前是否达到相切；
2. 达到阈值后自动吸附到相切位；
3. 支持临时关闭吸附以进行精细摆放。

本设计用于提升几何摆放精度和教学演示体验，避免“看起来快贴上了，但其实差一点”的反复拖拽。

## 2. 需求确认（已定）

1. 支持对象组合：
   - 圆-圆
   - 圆-直线
   - 圆-矩形边
   - 圆-三角边
2. 判定容差：`±2px`（严格）
3. 触发时机：拖拽 + 缩放
4. 反馈方式：视觉提示 + 自动吸附
5. 圆-圆关系：支持外切 + 内切
6. 多候选优先级：选择“最近候选”
7. 吸附控制：默认吸附，按住 `Alt/Option` 临时关闭
8. “圆”覆盖范围：所有可配置为圆形边界的场对象（不仅限电场圆）

## 3. 非目标（YAGNI）

1. 本期不支持“任意形状两两相切”（仅围绕“活动圆”展开）。
2. 本期不新增复杂约束系统（如多对象联合约束、锁定几何关系图）。
3. 本期不将吸附结果持久化为“约束定义”，只改变当前位置/尺寸。

## 4. 方案比较与选型

### 方案 A：在 `DragDropManager` 内直接实现实时相切检测（选定）

将候选收集、几何判定、优先级筛选、吸附解算放在拖拽/缩放主循环中；渲染层只消费结果并绘制提示。

优点：
1. 接入点明确，开发量最小；
2. 交互时延最低；
3. 可复用现有 `distancePointToSegment` 等几何逻辑。

风险：
1. 交互层逻辑体积会增大；
2. 需要通过函数拆分控制复杂度。

### 方案 B：抽独立 `TangencyService`

优点：解耦更强、单测更优。
代价：首版开发和集成成本更高。

### 方案 C：先提示后吸附分阶段

优点：风险最低。
代价：不满足“当前就要提示+吸附”的目标。

结论：选择方案 A，并通过轻量模块化（私有 helper）降低交互层膨胀风险。

## 5. 总体架构

### 5.1 职责划分

1. `DragDropManager`：
   - 在拖拽/缩放帧中计算相切命中；
   - 生成吸附目标并在允许时应用；
   - 写入临时提示态（供渲染层读取）。
2. `Renderer`：
   - 读取提示态并绘制高亮、标签；
   - 不参与几何判定。
3. `Scene`：
   - 保存运行期交互态 `interaction.tangencyHint`（非序列化）。

### 5.2 运行期状态

建议引入临时结构：

```js
scene.interaction = scene.interaction || {};
scene.interaction.tangencyHint = {
  activeObjectId: '...',
  activeType: 'move' | 'resize',
  relation: 'circle-circle-outer' | 'circle-circle-inner' | 'circle-line',
  candidateObjectId: '...',
  errorPx: 1.2,
  applied: true,       // 本帧是否已吸附
  suppressed: false,   // 是否因 Alt/Option 抑制吸附
  snapTarget: { x, y, radius },
  label: '相切（外切）'
};
```

该状态仅用于 UI 提示，不进入 `Scene.serialize()`。

## 6. 几何模型与数据提取

核心统一为“活动圆 vs 候选边界（圆或线段）”。

### 6.1 活动圆提取

从当前被操作对象提取活动圆：

1. 移动模式：圆心可变、半径固定；
2. 缩放模式（半径手柄）：圆心固定、半径可变。

圆来源包括：
1. `electric-field-circle`
2. `magnetic-field` 且 `shape === circle`
3. 其他后续可扩展的圆形对象（通过对象属性判定）

### 6.2 候选边界提取

对其他对象提取几何边界：

1. 圆对象 -> 圆候选 `{cx, cy, r}`
2. 直线对象（如 disappear-zone）-> 线段候选 `{x1, y1, x2, y2}`
3. 矩形对象 -> 四条边线段
4. 三角对象 -> 三条边线段

排除规则：
1. 排除自身对象；
2. 排除无效几何（半径<=0、线段退化）；
3. 本期不处理半圆弧边相切（未纳入已确认范围）。

## 7. 判定与吸附算法

### 7.1 圆-圆相切

设活动圆 `A(ca, ra)`，候选圆 `B(cb, rb)`，中心距 `d = |ca-cb|`。

1. 外切误差：`errOuter = |d - (ra + rb)|`
2. 内切误差：`errInner = |d - |ra - rb||`
3. 取更小误差对应的关系类型。
4. 命中条件：`min(errOuter, errInner) <= 2`

### 7.2 圆-线段相切

设线段 `L(p1, p2)`，圆心到线段最短距离 `dist`。
误差：`err = |dist - ra|`，命中条件 `err <= 2`。

点到线段距离可复用 `PhysicsEngine.distancePointToSegment` 同等算法。

### 7.3 多候选冲突消解

当多个候选同时命中时，按以下顺序排序取首个：

1. 误差 `errorPx` 更小优先；
2. 需要位移/缩放改变量更小优先；
3. 仍相同则按候选遍历顺序稳定选取。

该规则等价于“最近候选优先”，并保证帧间稳定。

### 7.4 吸附解算

1. 移动模式：解算目标圆心 `(x, y)` 并写回对象位置；
2. 缩放模式：保持圆心不动，解算目标半径 `r` 并写回。

修饰键规则：
1. 未按 `Alt/Option`：命中则吸附；
2. 按住 `Alt/Option`：仅提示，不吸附（`suppressed = true`）。

## 8. 交互与渲染反馈

在场层绘制，不改对象持久样式：

1. 活动对象高亮环（青色虚线）；
2. 命中候选边界高亮（圆描边或线段加亮）；
3. 标签：`相切` + `外切/内切` + `Alt可取消吸附`（命中时显示）。

生命周期：
1. 拖拽/缩放帧更新 `tangencyHint`；
2. 释放指针（`pointerup/mouseup`）立即清空 `tangencyHint`；
3. 选择变化或删除对象时也清空，避免残影。

## 9. 性能与稳定性策略

1. 候选剪枝：先按圆心粗距筛掉远对象，仅计算近邻。
2. 早停：若存在 `errorPx === 0` 的完美命中可直接采用。
3. 降抖：候选切换时可加极小迟滞（如 0.3px）避免边界抖动。
4. 容错：所有几何输入先做 `Number.isFinite` 校验；异常直接跳过候选。

## 10. 对现有功能的影响评估

1. 导入/导出：无格式变化。`tangencyHint` 不参与序列化。
2. 打开/保存：无兼容性风险，不新增存档字段。
3. 暂停态渲染：沿用当前“暂停时立即 render”机制，可实时看到提示。
4. 现有拖拽删除粒子/相机平移逻辑：不变（仅对场对象启用）。

## 11. 测试计划

### 11.1 单元测试（几何）

1. 圆-圆外切/内切命中与非命中边界值（1.9/2.0/2.1px）。
2. 圆-线段命中（水平、竖直、斜线、端点附近）。
3. 退化输入（零长线段、半径<=0、NaN）不会抛错。

### 11.2 交互测试

1. 拖拽触发提示与吸附；
2. 缩放触发提示与吸附；
3. 按住 `Alt/Option` 时提示存在但不吸附；
4. 多候选时稳定选择最近候选。

### 11.3 回归测试

1. 选中框、缩放手柄显示正常；
2. 暂停状态拖拽渲染不闪烁；
3. 导入导出后无额外状态污染。

## 12. 实施建议（下一步）

1. 在 `DragDropManager` 增加私有 helper：
   - `collectTangencyCandidates()`
   - `computeTangencyMatch()`
   - `applyTangencySnapIfNeeded()`
   - `clearTangencyHint()`
2. 在 `Renderer.renderFields()` 末尾增加 `drawTangencyHint(scene)`。
3. 增加几何单测（先测算法，再测交互）。

---

该文档已覆盖：架构、组件、数据流、异常处理、测试策略，并与已确认需求保持一致。
