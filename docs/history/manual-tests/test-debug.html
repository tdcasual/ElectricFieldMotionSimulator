<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>å®Œæ•´åŠŸèƒ½æµ‹è¯•</title>
    <link rel="stylesheet" href="styles/theme.css">
    <link rel="stylesheet" href="styles/main.css">
    <link rel="stylesheet" href="styles/components.css">
    <style>
        body {
            margin: 0;
            padding: 0;
        }
        #debug-panel {
            position: fixed;
            top: 10px;
            right: 10px;
            width: 300px;
            background: rgba(0, 0, 0, 0.9);
            color: #0f0;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 90vh;
            overflow-y: auto;
            z-index: 10000;
        }
        #debug-panel h3 {
            margin: 0 0 10px 0;
            color: #ff0;
        }
        #debug-panel .log-entry {
            margin: 3px 0;
            padding: 2px 5px;
            border-left: 2px solid #0f0;
        }
        #debug-panel .log-entry.error {
            border-left-color: #f00;
            color: #f00;
        }
        #debug-panel .log-entry.success {
            border-left-color: #0f0;
            color: #0f0;
        }
        #debug-panel .log-entry.info {
            border-left-color: #0ff;
            color: #0ff;
        }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 5px 10px;
            margin: 5px 5px 5px 0;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
        }
        .test-button:hover {
            background: #0056b3;
        }
    </style>
</head>
<body>
    <div id="app">
        <header id="header">
            <h1>å®Œæ•´åŠŸèƒ½æµ‹è¯•</h1>
            <div class="header-controls">
                <button id="theme-toggle-btn" class="btn" title="åˆ‡æ¢ä¸»é¢˜">ğŸŒ™</button>
                <button id="play-pause-btn" class="btn btn-primary">â–¶ï¸</button>
            </div>
        </header>

        <aside id="toolbar">
            <h2>ç»„ä»¶åº“</h2>
            <div class="tool-section">
                <h3>ç”µåœº</h3>
                <div class="tool-item" draggable="true" data-type="electric-field-rect">å‡åŒ€ç”µåœº</div>
                <div class="tool-item" draggable="true" data-type="electric-field-circle">åœ†å½¢ç”µåœº</div>
                <div class="tool-item" draggable="true" data-type="electric-field-semicircle">åŠåœ†ç”µåœº</div>
                <div class="tool-item" draggable="true" data-type="capacitor">å¹³è¡Œæ¿ç”µå®¹å™¨</div>
            </div>
        </aside>

        <main id="canvas-container">
            <canvas id="grid-canvas"></canvas>
            <canvas id="field-canvas"></canvas>
            <canvas id="particle-canvas"></canvas>
        </main>
    </div>

    <div id="debug-panel">
        <h3>ğŸ” è°ƒè¯•æ§åˆ¶å°</h3>
        <div>
            <button class="test-button" onclick="testThemeToggle()">æµ‹è¯•ä¸»é¢˜åˆ‡æ¢</button>
            <button class="test-button" onclick="testDragDrop()">æµ‹è¯•æ‹–æ‹½</button>
            <button class="test-button" onclick="clearLogs()">æ¸…ç©ºæ—¥å¿—</button>
        </div>
        <hr style="border-color: #333; margin: 10px 0;">
        <div id="log-container"></div>
    </div>

    <script type="module">
        import { ThemeManager } from '../../../js/utils/ThemeManager.js';
        import { SemiCircleElectricField } from '../../../js/objects/SemiCircleElectricField.js';
        import { ParallelPlateCapacitor } from '../../../js/objects/ParallelPlateCapacitor.js';
        
        const logContainer = document.getElementById('log-container');
        
        window.addLog = function(msg, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${timestamp}] ${msg}`;
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
            console.log(`[${type.toUpperCase()}]`, msg);
        };
        
        window.clearLogs = function() {
            logContainer.innerHTML = '';
            addLog('æ—¥å¿—å·²æ¸…ç©º', 'info');
        };
        
        addLog('é¡µé¢åŠ è½½å®Œæˆ', 'success');
        
        // æµ‹è¯•ThemeManager
        let themeManager;
        try {
            themeManager = new ThemeManager();
            addLog('âœ… ThemeManager åˆå§‹åŒ–æˆåŠŸ', 'success');
            addLog(`å½“å‰ä¸»é¢˜: ${themeManager.getCurrentTheme()}`, 'info');
        } catch (error) {
            addLog(`âŒ ThemeManager åˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
            console.error(error);
        }
        
        // æµ‹è¯•ä¸»é¢˜åˆ‡æ¢æŒ‰é’®
        const themeBtn = document.getElementById('theme-toggle-btn');
        if (themeBtn) {
            themeBtn.addEventListener('click', () => {
                addLog('ä¸»é¢˜åˆ‡æ¢æŒ‰é’®è¢«ç‚¹å‡»', 'info');
                if (themeManager) {
                    try {
                        themeManager.toggle();
                        addLog(`âœ… ä¸»é¢˜å·²åˆ‡æ¢åˆ°: ${themeManager.getCurrentTheme()}`, 'success');
                    } catch (error) {
                        addLog(`âŒ ä¸»é¢˜åˆ‡æ¢å¤±è´¥: ${error.message}`, 'error');
                    }
                } else {
                    addLog('âŒ ThemeManager æœªåˆå§‹åŒ–', 'error');
                }
            });
            addLog('âœ… ä¸»é¢˜åˆ‡æ¢æŒ‰é’®äº‹ä»¶å·²ç»‘å®š', 'success');
        } else {
            addLog('âŒ æ‰¾ä¸åˆ°ä¸»é¢˜åˆ‡æ¢æŒ‰é’®', 'error');
        }
        
        window.testThemeToggle = function() {
            addLog('æ‰§è¡Œä¸»é¢˜åˆ‡æ¢æµ‹è¯•...', 'info');
            themeBtn.click();
        };
        
        // æµ‹è¯•æ‹–æ‹½ç³»ç»Ÿ
        const canvas = document.getElementById('particle-canvas');
        let dragDropInitialized = false;
        
        if (canvas) {
            addLog('âœ… æ‰¾åˆ°Canvaså…ƒç´ ', 'success');
            
            // è®¾ç½®Canvaså¤§å°
            canvas.width = 800;
            canvas.height = 600;
            
            // å·¥å…·æ æ‹–æ‹½äº‹ä»¶
            document.querySelectorAll('.tool-item').forEach((item, index) => {
                item.addEventListener('dragstart', (e) => {
                    e.dataTransfer.effectAllowed = 'copy';
                    e.dataTransfer.setData('component-type', item.dataset.type);
                    addLog(`ğŸ¯ å¼€å§‹æ‹–æ‹½: ${item.dataset.type}`, 'info');
                });
            });
            addLog(`âœ… å·²ç»‘å®š ${document.querySelectorAll('.tool-item').length} ä¸ªå·¥å…·é¡¹çš„æ‹–æ‹½äº‹ä»¶`, 'success');
            
            // Canvasæ¥æ”¶æ‹–æ‹½
            canvas.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'copy';
            });
            
            canvas.addEventListener('drop', (e) => {
                e.preventDefault();
                const type = e.dataTransfer.getData('component-type');
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                addLog(`ğŸ“ é‡Šæ”¾åœ¨Canvas: ${type} at (${x.toFixed(0)}, ${y.toFixed(0)})`, 'info');
                
                let object = null;
                
                try {
                    switch (type) {
                        case 'electric-field-semicircle':
                            object = new SemiCircleElectricField({ x, y, radius: 100, strength: 1000, direction: 90, orientation: 0 });
                            addLog('âœ… åˆ›å»ºåŠåœ†ç”µåœºæˆåŠŸ', 'success');
                            break;
                        case 'capacitor':
                            object = new ParallelPlateCapacitor({ x, y, width: 300, height: 200, plateDistance: 100, strength: 1000, direction: 0, polarity: 1 });
                            addLog('âœ… åˆ›å»ºå¹³è¡Œæ¿ç”µå®¹å™¨æˆåŠŸ', 'success');
                            break;
                        case 'electric-field-rect':
                            addLog('âœ… çŸ©å½¢ç”µåœº (æœªå®ç°ç»˜åˆ¶)', 'info');
                            break;
                        case 'electric-field-circle':
                            addLog('âœ… åœ†å½¢ç”µåœº (æœªå®ç°ç»˜åˆ¶)', 'info');
                            break;
                        default:
                            addLog(`âš ï¸ æœªçŸ¥ç±»å‹: ${type}`, 'error');
                            return;
                    }
                    
                    if (object) {
                        addLog(`å¯¹è±¡å±æ€§: type=${object.type}, x=${object.x}, y=${object.y}`, 'info');
                        
                        // æµ‹è¯•getFieldAtæ–¹æ³•
                        const field = object.getFieldAt(x, y);
                        addLog(`ç”µåœºå¼ºåº¦: (${field.x.toFixed(2)}, ${field.y.toFixed(2)}, ${field.z.toFixed(2)})`, 'info');
                        
                        // æµ‹è¯•containsPointæ–¹æ³•
                        const contains = object.containsPoint(x, y);
                        addLog(`containsPoint(${x.toFixed(0)}, ${y.toFixed(0)}): ${contains}`, 'info');
                        
                        // ç»˜åˆ¶åˆ°Canvas
                        const ctx = canvas.getContext('2d');
                        ctx.strokeStyle = '#ff6b00';
                        ctx.lineWidth = 2;
                        
                        if (object.type === 'semicircle-electric-field') {
                            const angle = object.orientation * Math.PI / 180;
                            const startAngle = angle - Math.PI / 2;
                            const endAngle = angle + Math.PI / 2;
                            
                            ctx.beginPath();
                            ctx.arc(object.x, object.y, object.radius, startAngle, endAngle);
                            ctx.lineTo(object.x, object.y);
                            ctx.closePath();
                            ctx.stroke();
                            ctx.fillStyle = 'rgba(255, 200, 0, 0.2)';
                            ctx.fill();
                            
                            addLog('âœ… åŠåœ†ç”µåœºå·²ç»˜åˆ¶', 'success');
                        } else if (object.type === 'parallel-plate-capacitor') {
                            ctx.strokeStyle = '#00a8ff';
                            ctx.lineWidth = 3;
                            
                            const angle = object.direction * Math.PI / 180;
                            const cosAngle = Math.cos(angle);
                            const sinAngle = Math.sin(angle);
                            
                            const halfDist = object.plateDistance / 2;
                            const halfWidth = object.width / 2;
                            
                            const p1x1 = object.x - halfDist * sinAngle - halfWidth * cosAngle;
                            const p1y1 = object.y + halfDist * cosAngle - halfWidth * sinAngle;
                            const p1x2 = object.x - halfDist * sinAngle + halfWidth * cosAngle;
                            const p1y2 = object.y + halfDist * cosAngle + halfWidth * sinAngle;
                            
                            const p2x1 = object.x + halfDist * sinAngle - halfWidth * cosAngle;
                            const p2y1 = object.y - halfDist * cosAngle - halfWidth * sinAngle;
                            const p2x2 = object.x + halfDist * sinAngle + halfWidth * cosAngle;
                            const p2y2 = object.y - halfDist * cosAngle + halfWidth * sinAngle;
                            
                            ctx.beginPath();
                            ctx.moveTo(p1x1, p1y1);
                            ctx.lineTo(p1x2, p1y2);
                            ctx.stroke();
                            
                            ctx.beginPath();
                            ctx.moveTo(p2x1, p2y1);
                            ctx.lineTo(p2x2, p2y2);
                            ctx.stroke();
                            
                            addLog('âœ… å¹³è¡Œæ¿ç”µå®¹å™¨å·²ç»˜åˆ¶', 'success');
                        }
                    }
                    
                } catch (error) {
                    addLog(`âŒ é”™è¯¯: ${error.message}`, 'error');
                    console.error(error);
                }
            });
            
            dragDropInitialized = true;
            addLog('âœ… æ‹–æ‹½ç³»ç»Ÿå·²åˆå§‹åŒ–', 'success');
        } else {
            addLog('âŒ æ‰¾ä¸åˆ°Canvaså…ƒç´ ', 'error');
        }
        
        window.testDragDrop = function() {
            if (dragDropInitialized) {
                addLog('æ‹–æ‹½ç³»ç»Ÿå·²å°±ç»ªï¼Œè¯·ä»å·¦ä¾§å·¥å…·æ æ‹–åŠ¨ç»„ä»¶åˆ°Canvas', 'info');
            } else {
                addLog('âŒ æ‹–æ‹½ç³»ç»Ÿæœªåˆå§‹åŒ–', 'error');
            }
        };
        
        // æ•è·æ‰€æœ‰æœªå¤„ç†çš„é”™è¯¯
        window.addEventListener('error', (e) => {
            addLog(`âŒ å…¨å±€é”™è¯¯: ${e.message}`, 'error');
            addLog(`   ä½ç½®: ${e.filename}:${e.lineno}:${e.colno}`, 'error');
        });
        
        window.addEventListener('unhandledrejection', (e) => {
            addLog(`âŒ æœªå¤„ç†çš„Promiseæ‹’ç»: ${e.reason}`, 'error');
        });
        
        addLog('ğŸš€ æ‰€æœ‰æµ‹è¯•å°±ç»ª', 'success');
    </script>
</body>
</html>
